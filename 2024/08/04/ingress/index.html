<!DOCTYPE html>
<html lang='zh-CN'>

<head>
  <meta name="generator" content="Hexo 7.3.0">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.19.0">
  <meta charset="utf-8">
  

  <meta http-equiv='x-dns-prefetch-control' content='on' />
  <link rel='dns-prefetch' href='https://gcore.jsdelivr.net'>
  <link rel="preconnect" href="https://gcore.jsdelivr.net" crossorigin>
  <link rel='dns-prefetch' href='//unpkg.com'>

  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" content="#f8f8f8">
  
  <title>åŸºäº Nginx çš„å¼‚æ„åç«¯ç»Ÿä¸€é‰´æƒæœåŠ¡ğŸ›¡ï¸ - H-sediment</title>

  
    <meta name="description" content="JWT authorization with NGINX Ingress Controller">
<meta property="og:type" content="article">
<meta property="og:title" content="åŸºäº Nginx çš„å¼‚æ„åç«¯ç»Ÿä¸€é‰´æƒæœåŠ¡ğŸ›¡ï¸">
<meta property="og:url" content="http://example.com/2024/08/04/ingress/index.html">
<meta property="og:site_name" content="H-sediment">
<meta property="og:description" content="JWT authorization with NGINX Ingress Controller">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hcjjj/blog-img/20240805164624.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hcjjj/blog-img@master/83606cb5-8ecd-4e3b-99b5-5fd504b44a7b.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hcjjj/blog-img/20240805165418.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hcjjj/blog-img/20240806160759.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hcjjj/blog-img/Untitled%20diagram-2024-08-06-072719.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hcjjj/blog-img/20240805165509.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/hcjjj/blog-img/20240808191113.png">
<meta property="article:published_time" content="2024-08-04T09:37:55.000Z">
<meta property="article:modified_time" content="2024-12-22T12:23:01.354Z">
<meta property="article:author" content="hcjjj">
<meta property="article:tag" content="Nginx">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="JWT">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/hcjjj/blog-img/20240805164624.png">
  
  
  
  <meta name="keywords" content="Nginx,Kubernetes,JWT">

  <!-- feed -->
  

  
    
<link rel="stylesheet" href="/css/main.css">

  

  
    <link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/hcjjj/blog-img/icon.png">
  

  

  
    <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css" integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
    <script defer src="https://gcore.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js" integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" crossorigin="anonymous"></script>
    <script defer src="https://gcore.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"onload="renderMathInElement(document.body);"></script>
  


  
</head>

<body>
  




  <div class='l_body' id='start'>
    <aside class='l_left' layout='post'>
    

  

<header class="header"><div class="logo-wrap"><a class="avatar" href="/about/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.4/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="https://cdn.jsdelivr.net/gh/hcjjj/blog-img/avatar.jpg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.4/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title">H-sediment</div><div class="sub cap">dust in the wind</div></a></div>

<nav class="menu dis-select"><a class="nav-item active" href="/">æ–‡ç« </a><a class="nav-item" href="/about/">About</a></nav>
</header>


<div class="widgets">
<widget class="widget-wrapper search"><div class="widget-body"><div class="search-wrapper" id="search"><form class="search-form"><input type="text" class="search-input" id="search-input" data-filter="/blog/" placeholder="æ–‡ç« æœç´¢"><svg t="1670596976048" class="icon search-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2676" width="200" height="200"><path d="M938.2 832.6L723.8 618.1c-2.5-2.5-5.3-4.4-7.9-6.4 36.2-55.6 57.3-121.8 57.3-193.1C773.3 222.8 614.6 64 418.7 64S64 222.8 64 418.6c0 195.9 158.8 354.6 354.6 354.6 71.3 0 137.5-21.2 193.2-57.4 2 2.7 3.9 5.4 6.3 7.8L832.5 938c14.6 14.6 33.7 21.9 52.8 21.9 19.1 0 38.2-7.3 52.8-21.8 29.2-29.1 29.2-76.4 0.1-105.5M418.7 661.3C284.9 661.3 176 552.4 176 418.6 176 284.9 284.9 176 418.7 176c133.8 0 242.6 108.9 242.6 242.7 0 133.7-108.9 242.6-242.6 242.6" p-id="2677"></path></svg></form><div id="search-result"></div><div class="search-no-result">æ²¡æœ‰æ‰¾åˆ°å†…å®¹ï¼</div></div></div></widget>


<widget class="widget-wrapper toc single" id="data-toc"><div class="widget-header cap dis-select"><span class="name">åŸºäº Nginx çš„å¼‚æ„åç«¯ç»Ÿä¸€é‰´æƒæœåŠ¡ğŸ›¡ï¸</span></div><div class="widget-body fs14"><div class="doc-tree active"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86"><span class="toc-number">1.</span> <span class="toc-text">èƒŒæ™¯çŸ¥è¯†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JWT-%E9%AA%8C%E8%AF%81"><span class="toc-number">1.1.</span> <span class="toc-text">JWT éªŒè¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RBAC-%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.2.</span> <span class="toc-text">RBAC æ¨¡å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%90%E6%B5%81%E7%BB%84%E4%BB%B6"><span class="toc-number">1.3.</span> <span class="toc-text">é™æµç»„ä»¶</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx"><span class="toc-number">2.</span> <span class="toc-text">Nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">2.1.</span> <span class="toc-text">åŸºæœ¬æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.2.</span> <span class="toc-text">é…ç½®æ–‡ä»¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">2.3.</span> <span class="toc-text">å¸¸ç”¨å‘½ä»¤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97"><span class="toc-number">2.4.</span> <span class="toc-text">å¸¸ç”¨æ¨¡å—</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E9%89%B4%E6%9D%83"><span class="toc-number">3.</span> <span class="toc-text">ç»Ÿä¸€é‰´æƒ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%89%B4%E6%9D%83%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.</span> <span class="toc-text">é‰´æƒæœåŠ¡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JWT-%E6%A0%A1%E9%AA%8C"><span class="toc-number">4.1.</span> <span class="toc-text">JWT æ ¡éªŒ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E9%99%90%E6%B5%81"><span class="toc-number">4.2.</span> <span class="toc-text">è¯·æ±‚é™æµ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RBAC-%E9%89%B4%E6%9D%83"><span class="toc-number">4.3.</span> <span class="toc-text">RBAC é‰´æƒ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ingress"><span class="toc-number">5.</span> <span class="toc-text">Ingress</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx-Ingress"><span class="toc-number">5.1.</span> <span class="toc-text">Nginx Ingress</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%89%A9%E5%B1%95"><span class="toc-number">5.2.</span> <span class="toc-text">ç›¸å…³æ‰©å±•</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95"><span class="toc-number">6.</span> <span class="toc-text">é—®é¢˜è®°å½•</span></a></li></ol></div></div></widget>




</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="https://github.com/hcjjj" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/08a41b181ce68.svg"/></a><a class="social" href="/hcjjj@foxmail.com" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/a1b00e20f425d.svg"/></a><a class="social" href="/H_sediment" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/b32ef3da1162a.svg"/></a><a class="social" href="/" rel="noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.12/social/3845874.svg"/></a></div></footer>

    </aside>
    <div class='l_main'>
      

      



<div class="bread-nav fs12"><div id="breadcrumb"><a class="cap breadcrumb" href="/">ä¸»é¡µ</a><span class="sep"></span><a class="cap breadcrumb" href="/">æ–‡ç« </a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/Internship/">Internship</a></div><div id="post-meta">å‘å¸ƒäº&nbsp;<time datetime="2024-08-04T09:37:55.000Z">2024-08-04</time></div></div>

<article class='md-text content post'>
<h1 class="article-title"><span>åŸºäº Nginx çš„å¼‚æ„åç«¯ç»Ÿä¸€é‰´æƒæœåŠ¡ğŸ›¡ï¸</span></h1>
<p><strong>JWT authorization with NGINX Ingress Controller</strong></p>
<span id="more"></span>

<h2 id="èƒŒæ™¯çŸ¥è¯†"><a href="#èƒŒæ™¯çŸ¥è¯†" class="headerlink" title="èƒŒæ™¯çŸ¥è¯†"></a>èƒŒæ™¯çŸ¥è¯†</h2><h3 id="JWT-éªŒè¯"><a href="#JWT-éªŒè¯" class="headerlink" title="JWT éªŒè¯"></a>JWT éªŒè¯</h3><p>JWTï¼ˆJSON Web Tokenï¼‰æ˜¯ä¸€ç§å¼€æ”¾æ ‡å‡†ï¼ˆRFC 7519ï¼‰ï¼Œç”¨äºåœ¨ç½‘ç»œåº”ç”¨ç¯å¢ƒä¸­å®‰å…¨åœ°ä¼ é€’ä¿¡æ¯ã€‚JWT çš„è®¾è®¡ç›®çš„æ˜¯ä¸ºäº†åœ¨å„æ–¹ä¹‹é—´å®‰å…¨åœ°ä¼ è¾“å£°æ˜ï¼ˆclaimï¼‰ï¼Œè¿™äº›å£°æ˜å¯ä»¥åŒ…å«å…³äºç”¨æˆ·èº«ä»½ï¼ˆIDï¼‰ã€æƒé™æˆ–å…¶ä»–å…ƒæ•°æ®çš„ä¿¡æ¯ã€‚</p>
<p>JWT çš„ç»“æ„</p>
<p>ä¸€ä¸ª JWT é€šå¸¸ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«ç”¨ç‚¹ï¼ˆ.ï¼‰åˆ†éš”ï¼š</p>
<ul>
<li><strong>å¤´éƒ¨ï¼ˆHeaderï¼‰ï¼Œ</strong>åŒ…å«ä»¤ç‰Œçš„ç±»å‹ï¼ˆé€šå¸¸æ˜¯ â€œJWTâ€ï¼‰å’Œæ‰€ä½¿ç”¨çš„ç­¾åç®—æ³•ï¼ˆå¦‚ SHA256ã€RSAã€ECDSAï¼‰</li>
<li><strong>è´Ÿè½½ï¼ˆPayloadï¼‰ï¼Œ</strong>åŒ…å«å®é™…çš„æ•°æ®ï¼ˆå£°æ˜ï¼‰ï¼Œè¿™äº›å£°æ˜å¯ä»¥æ˜¯å…¬å¼€å£°æ˜ã€ç§æœ‰å£°æ˜æˆ–æ³¨å†Œå£°æ˜ã€‚<ul>
<li>å…¬å¼€å£°æ˜ï¼šå¯ä»¥åŒ…å«åœ¨ JWT ä¸­çš„æ ‡å‡†åŒ–å£°æ˜ï¼Œä¾‹å¦‚ issï¼ˆå‘è¡Œè€…ï¼‰ã€expï¼ˆè¿‡æœŸæ—¶é—´ï¼‰ã€subï¼ˆä¸»é¢˜ï¼‰ç­‰ã€‚</li>
<li>ç§æœ‰å£°æ˜ï¼šç”¨æˆ·è‡ªå®šä¹‰çš„æ•°æ®ï¼Œä¸æ˜¯æ ‡å‡†åŒ–çš„å£°æ˜ï¼Œéœ€è¦åŒæ–¹åå•†ä¸€è‡´ã€‚</li>
<li>æ³¨å†Œå£°æ˜ï¼šä¸€äº›é¢„å®šä¹‰çš„å£°æ˜ï¼Œç”¨äºåœ¨ JWT ä¸­ä¼ é€’ç”¨æˆ·ç›¸å…³çš„åŸºæœ¬ä¿¡æ¯ã€‚</li>
<li>è´Ÿè½½éƒ¨åˆ†çš„å†…å®¹æ˜¯ Base64Url ç¼–ç çš„ JSON å¯¹è±¡ã€‚</li>
</ul>
</li>
<li><strong>ç­¾åï¼ˆSignatureï¼‰ï¼Œ</strong>ç”±å¤´éƒ¨å’Œè´Ÿè½½éƒ¨åˆ†çš„æ•°æ®ä»¥åŠä¸€ä¸ªå¯†é’¥ç»è¿‡ç‰¹å®šç®—æ³•ï¼ˆå¦‚ HMAC SHA256ã€RSA ç­‰ï¼‰ç”Ÿæˆï¼Œç”¨äºéªŒè¯ JWT çš„å®Œæ•´æ€§ã€‚</li>
</ul>
<div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hcjjj/blog-img/20240805164624.png" fancybox="true"/></div></div>

<p><strong>æ— çŠ¶æ€ç‰¹æ€§</strong></p>
<p>JWT åŒ…å«äº†æ‰€æœ‰å¿…è¦çš„ç”¨æˆ·èº«ä»½å’Œæƒé™ä¿¡æ¯ï¼ˆå¦‚ç”¨æˆ· IDã€æƒé™ç­‰ï¼‰ï¼Œå¹¶é€šè¿‡ç­¾åä¿è¯æ•°æ®çš„å®Œæ•´æ€§ã€‚å½“å®¢æˆ·ç«¯æ¯æ¬¡å‘é€è¯·æ±‚æ—¶ï¼Œä¼šå°† JWT ä»¤ç‰ŒåŒ…å«åœ¨è¯·æ±‚å¤´ä¸­ï¼ŒæœåŠ¡å™¨é€šè¿‡éªŒè¯è¯¥ä»¤ç‰Œæ¥è¿›è¡Œèº«ä»½éªŒè¯å’Œæˆæƒï¼Œè€Œä¸éœ€è¦ç»´æŠ¤å’ŒæŸ¥è¯¢æœåŠ¡å™¨ç«¯çš„ä¼šè¯æ•°æ®ã€‚æœåŠ¡å™¨åªéœ€æ£€æŸ¥ JWT çš„ç­¾åå’Œæœ‰æ•ˆæ€§ï¼Œè€Œä¸éœ€è¦å­˜å‚¨ä»»ä½•ä¼šè¯æ•°æ®ã€‚</p>
<p><strong>å®‰å…¨æ€§è€ƒè™‘</strong></p>
<p>JWTï¼ˆJSON Web Tokenï¼‰çš„æ•°æ®é€šå¸¸ <strong>ä¸è¢«åŠ å¯†</strong>ï¼Œè€Œæ˜¯ <strong>ç­¾å</strong> æ¥ä¿è¯æ•°æ®çš„å®Œæ•´æ€§å’ŒçœŸå®æ€§ï¼Œç­¾åçš„ç›®çš„æ˜¯ç¡®ä¿ JWT çš„æ•°æ®æ²¡æœ‰è¢«ç¯¡æ”¹ã€‚æ¥æ”¶æ–¹ä½¿ç”¨ç›¸åŒçš„ç­¾åç®—æ³•å’Œå¯†é’¥æ¥éªŒè¯ç­¾åæ˜¯å¦åŒ¹é…ã€‚å¦‚æœä¸åŒ¹é…ï¼Œè¡¨æ˜æ•°æ®å¯èƒ½è¢«ç¯¡æ”¹ã€‚</p>
<p>JWT çš„å¤´éƒ¨ï¼ˆHeaderï¼‰å’Œè´Ÿè½½ï¼ˆPayloadï¼‰éƒ¨åˆ†ä¸€èˆ¬ <strong>ä¸åŠ å¯†</strong>ï¼Œåªè¿›è¡Œ Base64Url ç¼–ç ã€‚è¿™ç§ç¼–ç åªæ˜¯å°†æ•°æ®è½¬æ¢ä¸º URL å®‰å…¨çš„å­—ç¬¦ä¸²å½¢å¼ï¼Œå¹¶ä¸æä¾›ä»»ä½•å®‰å…¨æ€§ï¼Œä»»ä½•äººéƒ½å¯ä»¥è§£ç  JWTï¼ŒæŸ¥çœ‹å…¶ä¸­çš„å†…å®¹ã€‚è¿™æ„å‘³ç€æ•æ„Ÿä¿¡æ¯ä¸åº”è¯¥ç›´æ¥å­˜å‚¨åœ¨ JWT çš„è´Ÿè½½ä¸­ï¼Œé™¤éæ•°æ®ç»è¿‡åŠ å¯†æˆ–é‡‡å–äº†å…¶ä»–å®‰å…¨æªæ–½ã€‚</p>
<ul>
<li><p><strong>æ•°æ®åŠ å¯†</strong>ï¼šå¦‚æœéœ€è¦åœ¨ JWT ä¸­å­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼Œå¯ä»¥å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†åå†æ”¾å…¥è´Ÿè½½ä¸­ã€‚è¿™æ ·ï¼Œå³ä½¿ JWT è¢«æˆªè·ï¼Œæœªç»æˆæƒçš„ç¬¬ä¸‰æ–¹ä¹Ÿæ— æ³•è§£å¯†å’ŒæŸ¥çœ‹æ•°æ®ã€‚</p>
</li>
<li><p><strong>ä½¿ç”¨ HTTPS</strong>ï¼šä¸ºäº†é˜²æ­¢ JWT åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¢«æˆªè·ï¼Œåº”è¯¥ä½¿ç”¨ HTTPS è¿›è¡ŒåŠ å¯†é€šä¿¡ã€‚</p>
</li>
<li><p>å¦‚æœä½¿ç”¨ <strong>JWEï¼ˆJSON Web Encryptionï¼‰</strong> è§„èŒƒï¼Œå¯ä»¥å¯¹ JWT è¿›è¡ŒåŠ å¯†ï¼Œåªæœ‰æŒæœ‰è§£å¯†å¯†é’¥çš„æ–¹èƒ½è¯»å–ã€‚</p>
</li>
</ul>
<h3 id="RBAC-æ¨¡å‹"><a href="#RBAC-æ¨¡å‹" class="headerlink" title="RBAC æ¨¡å‹"></a>RBAC æ¨¡å‹</h3><p><strong>è¡¨è®¾è®¡</strong></p>
<ul>
<li>users</li>
<li>auth_user_roles</li>
<li>auth_role</li>
<li>auth_role_permissions</li>
<li>auth_permission</li>
</ul>
<div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hcjjj/blog-img@master/83606cb5-8ecd-4e3b-99b5-5fd504b44a7b.png" fancybox="true"/></div></div>

<h3 id="é™æµç»„ä»¶"><a href="#é™æµç»„ä»¶" class="headerlink" title="é™æµç»„ä»¶"></a>é™æµç»„ä»¶</h3><ul>
<li>åŸºäº Reids ZSet + Lua å®ç°çš„æ»‘åŠ¨çª—å£é™æµ</li>
</ul>
<blockquote>
<p>æ’é˜ŸæœåŠ¡ä¹Ÿç”¨åˆ°äº†è¿™ä¸ªé™æµç»„ä»¶ï¼Œæ’é˜ŸæœåŠ¡æ˜¯<strong>ç‰¹å®šæ¥å£è¯·æ±‚çš„é™æµ</strong>ã€é‰´æƒæœåŠ¡æ˜¯<strong>ç”¨æˆ·è¯·æ±‚çš„é™æµ</strong></p>
</blockquote>
<p><strong>types.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> limiter</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Limiter <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// è¿”å› trueï¼Œå°±æ˜¯è§¦å‘é™æµ</span></span><br><span class="line"></span><br><span class="line">	LimitDefault(ctx context.Context, key <span class="type">string</span>) (<span class="type">bool</span>, <span class="type">error</span>)</span><br><span class="line">	Limit(ctx context.Context, key <span class="type">string</span>, interval time.Duration, rate <span class="type">int64</span>, now time.Time) (<span class="type">bool</span>, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>redis_slide_window.go</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> limiter</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	_ <span class="string">&quot;embed&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/redis/go-redis/v9&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:embed slide_window.lua</span></span><br><span class="line"><span class="keyword">var</span> luaScript <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RedisSlidingWindowLimiter <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Redis å®¢æˆ·ç«¯</span></span><br><span class="line">	cmd redis.Cmdable</span><br><span class="line">	<span class="comment">// çª—å£å¤§å°</span></span><br><span class="line">	<span class="comment">// interval å†…å…è®¸ rate ä¸ªè¯·æ±‚</span></span><br><span class="line">	<span class="comment">// 1s å†…å…è®¸ 3000 ä¸ªè¯·æ±‚</span></span><br><span class="line">	interval time.Duration</span><br><span class="line">	<span class="comment">// é˜ˆå€¼</span></span><br><span class="line">	rate <span class="type">int64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRedisSlidingWindowLimiter</span><span class="params">(cmd redis.Cmdable, interval time.Duration, rate <span class="type">int64</span>)</span></span> Limiter &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;RedisSlidingWindowLimiter&#123;</span><br><span class="line">		cmd:      cmd,</span><br><span class="line">		interval: interval,</span><br><span class="line">		rate:     rate,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *RedisSlidingWindowLimiter)</span></span> LimitDefault(ctx context.Context, key <span class="type">string</span>) (<span class="type">bool</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// é”®ï¼ˆkeyï¼‰ã€çª—å£å¤§å°ï¼ˆintervalï¼‰ã€é€Ÿç‡ï¼ˆrateï¼‰ã€ä»¥åŠå½“å‰æ—¶é—´çš„æ¯«ç§’æ•°</span></span><br><span class="line">	<span class="keyword">return</span> b.cmd.Eval(ctx, luaScript, []<span class="type">string</span>&#123;key&#125;,</span><br><span class="line">		b.interval.Milliseconds(), b.rate, time.Now().UnixMilli()).Bool()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *RedisSlidingWindowLimiter)</span></span> Limit(ctx context.Context, key <span class="type">string</span>, interval time.Duration, rate <span class="type">int64</span>, now time.Time) (<span class="type">bool</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// è®¾ç½®é»˜è®¤å€¼</span></span><br><span class="line">	<span class="keyword">if</span> interval == <span class="number">0</span> &#123;</span><br><span class="line">		interval = b.interval</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> rate == <span class="number">0</span> &#123;</span><br><span class="line">		rate = b.rate</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> b.cmd.Eval(ctx, luaScript, []<span class="type">string</span>&#123;key&#125;,</span><br><span class="line">		interval.Milliseconds(), rate, now.UnixMilli()).Bool()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>slide_window.lua</strong></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">min</span> = now - window</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ é™¤è¿‡æœŸæ•°æ®</span></span><br><span class="line">redis.call(<span class="string">&#x27;ZREMRANGEBYSCORE&#x27;</span>, key, <span class="string">&#x27;-inf&#x27;</span>, <span class="built_in">min</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- è·å–å½“å‰çª—å£å†…çš„è¯·æ±‚æ•°</span></span><br><span class="line"><span class="keyword">local</span> cnt = redis.call(<span class="string">&#x27;ZCOUNT&#x27;</span>, key, <span class="string">&#x27;-inf&#x27;</span>, <span class="string">&#x27;+inf&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ£€æŸ¥å½“å‰æ—¶é—´æˆ³æ˜¯å¦å·²å­˜åœ¨äºé›†åˆä¸­</span></span><br><span class="line"><span class="keyword">local</span> exists = redis.call(<span class="string">&#x27;ZSCORE&#x27;</span>, key, now)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> cnt &gt;= threshold <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> exists <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;false&quot;</span>  <span class="comment">-- å…è®¸ç»§ç»­è¯·æ±‚</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;true&quot;</span>  <span class="comment">-- è§¦å‘é™æµ</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    redis.call(<span class="string">&#x27;ZADD&#x27;</span>, key, now, now)</span><br><span class="line">    redis.call(<span class="string">&#x27;PEXPIRE&#x27;</span>, key, window)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;false&quot;</span>  <span class="comment">-- å…è®¸ç»§ç»­è¯·æ±‚</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><h3 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h3><p>Nginx æ˜¯ç›®å‰æœ€æµè¡Œçš„ <strong>Web æœåŠ¡å™¨</strong>ï¼Œæœ€åˆç”±ä¸€ä½ä¿„ç½—æ–¯ç¨‹åºå‘˜ <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Igor_Sysoev">Igor Sysoev</a> å¼€å‘ã€‚2019 å¹´ï¼ŒNginx è¢«ç¾å›½çš„ F5 å…¬å¸ä»¥ 6.7 äº¿ç¾å…ƒæ”¶è´­ã€‚</p>
<ul>
<li>Nginx çš„å¼€æºç‰ˆæœ¬ä¸»è¦åˆ†ä¸ºä¸¤ç§ï¼š<ul>
<li>ä¸»çº¿ç‰ˆ (mainline)ï¼šæœ€æ–°ç‰ˆæœ¬ï¼ŒåŒ…å«è¾ƒå¤šæ–°åŠŸèƒ½å’Œæ­£åœ¨å¼€å‘çš„å®éªŒæ€§æ¨¡å—åŠŸèƒ½ï¼Œå¯èƒ½å­˜åœ¨ä¸€äº›æ–°çš„ bugã€‚</li>
<li>ç¨³å®šç‰ˆ (stable)ï¼šç»è¿‡é•¿æ—¶é—´æµ‹è¯•ï¼Œbug è¾ƒå°‘ï¼ŒåŠŸèƒ½è¾ƒä¸ºç¨³å®šã€‚</li>
</ul>
</li>
<li>å®‰è£…æ–¹å¼ï¼š<ul>
<li>æºç ç¼–è¯‘å®‰è£…ï¼šæ‹‰å–æºä»£ç åè‡ªå·±ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚</li>
<li>é¢„ç¼–è¯‘äºŒè¿›åˆ¶åŒ…ï¼šç›´æ¥ä¸‹è½½ç¼–è¯‘å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</li>
<li>Docker Composeï¼šæ‹‰å–é•œåƒåè¿è¡Œåœ¨å®¹å™¨ä¸­ã€‚</li>
</ul>
</li>
<li>ä¸»è¦ç”¨é€”ï¼š<ul>
<li>æ­£å‘&#x2F;åå‘ä»£ç†ï¼šä¸ºå®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚æˆ–ä¸ºæœåŠ¡å™¨æ¥æ”¶è¯·æ±‚ã€‚</li>
<li>è´Ÿè½½å‡è¡¡ï¼šå°†è¯·æ±‚åˆ†å‘åˆ°å¤šä¸ªæ“ä½œå•å…ƒä¸Šæ‰§è¡Œã€‚</li>
<li>HTTP æœåŠ¡å™¨ï¼šNginx ä¹Ÿå¯ä»¥ä½œä¸ºé™æ€èµ„æºæœåŠ¡å™¨ä½¿ç”¨ã€‚</li>
</ul>
</li>
</ul>
<h3 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><p>Nginx çš„ä¸»è¦é…ç½®æ–‡ä»¶é€šå¸¸æ˜¯ <code>nginx.conf</code>ï¼Œå¹¶ä¸”ä¸€èˆ¬ä½äº <code>/etc/nginx/</code> ç›®å½•ä¸‹ã€‚ä½¿ç”¨ <code>nginx -t</code> å‘½ä»¤å¯ä»¥æµ‹è¯•é…ç½®æ–‡ä»¶çš„æœ‰æ•ˆæ€§è€Œä¸éœ€è¦å®é™…é‡å¯ Nginx æœåŠ¡ã€‚</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Nginx é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># å…¨å±€å—</span></span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Events å—</span></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="comment"># å®šä¹‰äº‹ä»¶å¤„ç†æ¨¡å‹</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># HTTP å—</span></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="comment"># å¯ä»¥åœ¨è¿™é‡Œå®šä¹‰å…¨å±€çš„ HTTP è®¾ç½®ï¼Œä¾‹å¦‚ MIME ç±»å‹æ˜ å°„ã€é»˜è®¤é”™è¯¯é¡µé¢ç­‰ã€‚</span></span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="comment"># Server å€å—</span></span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;  <span class="comment"># ç¤ºä¾‹: ç›‘å¬ 80 ç«¯å£</span></span><br><span class="line">        <span class="attribute">server_name</span>  localhost;  <span class="comment"># ç¤ºä¾‹: æŒ‡å®šæœåŠ¡å™¨åç§°</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Location å—</span></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="comment"># è¿™é‡Œå¯ä»¥æŒ‡å®šå¦‚ä½•å¤„ç†è¯·æ±‚åˆ°æ ¹ç›®å½• &quot;/&quot; çš„æ‰€æœ‰è¯·æ±‚</span></span><br><span class="line">            <span class="attribute">root</span>   html;  <span class="comment"># ç¤ºä¾‹: æŒ‡å®šæ ¹ç›®å½•</span></span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;  <span class="comment"># ç¤ºä¾‹: æŒ‡å®šç´¢å¼•æ–‡ä»¶</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ›´å¤š location å—å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å…¨å±€å—</strong> </p>
<p>å…¨å±€å—æ˜¯é…ç½®æ–‡ä»¶çš„ç¬¬ä¸€ä¸ªå—ï¼Œä¹Ÿæ˜¯é…ç½®æ–‡ä»¶çš„ä¸»ä½“éƒ¨åˆ†ã€‚å®ƒä¸»è¦ç”¨æ¥è®¾ç½®ä¸€äº›å½±å“ Nginx æœåŠ¡å™¨æ•´ä½“è¿è¡Œçš„é…ç½®æŒ‡ä»¤ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºé…ç½®è¿è¡Œ Nginx æœåŠ¡å™¨çš„ç”¨æˆ·ï¼ˆç»„ï¼‰ã€å…è®¸ç”Ÿæˆçš„ worker process æ•°é‡ã€è¿›ç¨‹ PID å­˜æ”¾è·¯å¾„ã€æ—¥å¿—å­˜æ”¾è·¯å¾„å’Œç±»å‹ä»¥åŠé…ç½®æ–‡ä»¶çš„å¼•å…¥ç­‰ã€‚</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŒ‡å®šè¿è¡Œ Nginx æœåŠ¡å™¨çš„ç”¨æˆ·ï¼Œåªèƒ½åœ¨å…¨å±€å—é…ç½®</span></span><br><span class="line"><span class="comment"># å°† user æŒ‡ä»¤æ³¨é‡Šæ‰ï¼Œæˆ–è€…é…ç½®æˆ nobody çš„è¯æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥è¿è¡Œ</span></span><br><span class="line"><span class="comment"># user [user] [group];</span></span><br><span class="line"><span class="comment"># user nobody nobody;</span></span><br><span class="line"><span class="attribute">user</span> nginx;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šç”Ÿæˆçš„ worker è¿›ç¨‹çš„æ•°é‡ï¼Œä¹Ÿå¯ä½¿ç”¨è‡ªåŠ¨æ¨¡å¼ï¼Œåªèƒ½åœ¨å…¨å±€å—é…ç½®</span></span><br><span class="line"><span class="attribute">worker_processes</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># é”™è¯¯æ—¥å¿—å­˜æ”¾è·¯å¾„å’Œç±»å‹</span></span><br><span class="line"><span class="attribute">error_log</span> /var/log/nginx/<span class="literal">error</span>.log <span class="literal">warn</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›ç¨‹ PID å­˜æ”¾è·¯å¾„</span></span><br><span class="line"><span class="attribute">pid</span> /var/run/nginx.pid;</span><br></pre></td></tr></table></figure>

<p><strong>events å—</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="comment"># æŒ‡å®šä½¿ç”¨å“ªç§ç½‘ç»œ IO æ¨¡å‹ï¼Œåªèƒ½åœ¨ events å—ä¸­è¿›è¡Œé…ç½®</span></span><br><span class="line">    <span class="comment"># use epoll;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ¯ä¸ª worker process å…è®¸çš„æœ€å¤§è¿æ¥æ•°</span></span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>http å—</strong></p>
<p>http å—æ˜¯é…ç½®æ–‡ä»¶çš„ä¸»è¦éƒ¨åˆ†ï¼ŒåŒ…æ‹¬ http å…¨å±€å—å’Œ server å—  </p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="comment"># å¼•å…¥å…¶ä»–é…ç½®æ–‡ä»¶</span></span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/mime.types;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># é»˜è®¤ç±»å‹ï¼Œå¦‚æœè¯·æ±‚çš„ URL æ²¡æœ‰åŒ…å«æ–‡ä»¶ç±»å‹ï¼Œåˆ™ä½¿ç”¨é»˜è®¤ç±»å‹</span></span><br><span class="line">    <span class="attribute">default_type</span> application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¼€å¯é«˜æ•ˆæ–‡ä»¶ä¼ è¾“æ¨¡å¼</span></span><br><span class="line">    <span class="attribute">sendfile</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¿æ¥è¶…æ—¶æ—¶é—´</span></span><br><span class="line">    <span class="attribute">keepalive_timeout</span> <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Access log æ—¥å¿—å­˜æ”¾è·¯å¾„å’Œç±»å‹</span></span><br><span class="line">    <span class="comment"># æ ¼å¼ä¸ºï¼šaccess_log &lt;path&gt; [format [buffer = size] [gzip[= level]] [flush = time] [if = condition]];</span></span><br><span class="line">    <span class="attribute">access_log</span> /var/log/nginx/access.log main;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å®šä¹‰æ—¥å¿—æ ¼å¼</span></span><br><span class="line">    <span class="attribute">log_format</span> main <span class="string">&#x27;<span class="variable">$remote_addr</span> - $ remote_user [<span class="variable">$time_local</span>] &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;<span class="variable">$request</span>&quot; $ status <span class="variable">$body_bytes_sent</span> &quot;$ http_referer&quot; &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;<span class="variable">$http_user_agent</span>&quot; &quot;$ http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½® sendfile æœ€å¤§ä¼ è¾“ç‰‡æ®µå¤§å°ï¼Œé»˜è®¤ä¸º 0ï¼Œè¡¨ç¤ºä¸é™åˆ¶</span></span><br><span class="line">    <span class="comment"># sendfile_max_chunk 1m;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ¯ä¸ªè¿æ¥çš„è¯·æ±‚æ¬¡æ•°</span></span><br><span class="line">    <span class="comment"># keepalive_requests 100;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¼€å¯ gzip å‹ç¼©</span></span><br><span class="line">    <span class="comment"># gzip on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¼€å¯ gzip å‹ç¼©çš„æœ€å°æ–‡ä»¶å¤§å°</span></span><br><span class="line">    <span class="comment"># gzip_min_length 1k;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># gzip å‹ç¼©çº§åˆ«ï¼Œ1-9ï¼Œçº§åˆ«è¶Šé«˜å‹ç¼©ç‡è¶Šé«˜ï¼Œä½†æ˜¯æ¶ˆè€— CPU èµ„æºä¹Ÿè¶Šå¤š</span></span><br><span class="line">    <span class="comment"># gzip_comp_level 2;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># gzip å‹ç¼©æ–‡ä»¶ç±»å‹</span></span><br><span class="line">    <span class="comment"># gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># upstream æŒ‡ä»¤ç”¨äºå®šä¹‰ä¸€ç»„æœåŠ¡å™¨ï¼Œä¸€èˆ¬ç”¨æ¥é…ç½®åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡</span></span><br><span class="line">    <span class="section">upstream</span> www.example.com &#123;</span><br><span class="line">        <span class="comment"># ip_hash æŒ‡ä»¤ç”¨äºè®¾ç½®è´Ÿè½½å‡è¡¡çš„æ–¹å¼ï¼Œip_hash è¡¨ç¤ºä½¿ç”¨å®¢æˆ·ç«¯çš„ IP è¿›è¡Œ hashï¼Œ</span></span><br><span class="line">        <span class="comment"># è¿™æ ·å¯ä»¥ä¿è¯åŒä¸€ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚æ¯æ¬¡éƒ½ä¼šåˆ†é…åˆ°åŒä¸€ä¸ªæœåŠ¡å™¨ï¼Œè§£å†³äº† session å…±äº«çš„é—®é¢˜</span></span><br><span class="line">        ip_hash;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># weight ç”¨äºè®¾ç½®æƒé‡ï¼Œæƒé‡è¶Šé«˜è¢«åˆ†é…åˆ°çš„å‡ ç‡è¶Šå¤§</span></span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.50.11:80</span> weight = <span class="number">3</span>;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.50.12:80</span>;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.50.13:80</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># server å—</span></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="comment"># å‚è€ƒ server å—çš„é…ç½®</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>server å—</strong></p>
<p>server å—æ˜¯é…ç½®è™šæ‹Ÿä¸»æœºçš„ï¼Œâ¼€ä¸ª http å—å¯ä»¥åŒ…å«å¤šä¸ª server å—ï¼Œæ¯ä¸ª server å—å°±æ˜¯â¼€ä¸ªè™šæ‹Ÿä¸»æœº </p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="comment"># ç›‘å¬ IP å’Œç«¯å£</span></span><br><span class="line">    <span class="comment"># listen çš„æ ¼å¼ä¸ºï¼š</span></span><br><span class="line">    <span class="comment"># listen [ip]:port [default_server] [ssl] [http2] [spdy]</span></span><br><span class="line">    <span class="comment"># [proxy_protocol] [setfib = number] [fastopen = number] [backlog = number];</span></span><br><span class="line">    <span class="comment"># listen æŒ‡ä»¤éå¸¸çµæ´»ï¼Œå¯ä»¥æŒ‡å®šå¤šä¸ª IP å’Œç«¯å£ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é€šé…ç¬¦</span></span><br><span class="line">    <span class="comment"># ä¸‹é¢æ˜¯ä¸€äº›å®é™…çš„ä¾‹å­ï¼š</span></span><br><span class="line">    <span class="comment"># listen 127.0.0.1:80; # ç›‘å¬æ¥è‡ª 127.0.0.1 çš„ 80 ç«¯å£çš„è¯·æ±‚</span></span><br><span class="line">    <span class="comment"># listen 80; # ç›‘å¬æ¥è‡ªæ‰€æœ‰ IP çš„ 80 ç«¯å£çš„è¯·æ±‚</span></span><br><span class="line">    <span class="comment"># listen *: 80; # ç›‘å¬æ¥è‡ªæ‰€æœ‰ IP çš„ 80 ç«¯å£çš„è¯·æ±‚ï¼ŒåŒä¸Š</span></span><br><span class="line">    <span class="comment"># listen 127.0.0.1; # ç›‘å¬æ¥è‡ª 127.0.0.1 çš„ 80 ç«¯å£ï¼Œé»˜è®¤ç«¯å£ä¸º 80</span></span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># server_name ç”¨æ¥æŒ‡å®šè™šæ‹Ÿä¸»æœºçš„åŸŸåï¼Œå¯ä»¥ä½¿ç”¨ç²¾ç¡®åŒ¹é…ã€é€šé…ç¬¦åŒ¹é…å’Œæ­£åˆ™åŒ¹é…ç­‰æ–¹å¼</span></span><br><span class="line">    <span class="comment"># server_name example.org www.example.org; # ç²¾ç¡®åŒ¹é…</span></span><br><span class="line">    <span class="comment"># server_name *.example.org; # é€šé…ç¬¦åŒ¹é…</span></span><br><span class="line">    <span class="comment"># server_name ~^www\d+\.example\.net$; # æ­£åˆ™åŒ¹é…</span></span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># location å—ç”¨æ¥é…ç½®è¯·æ±‚çš„è·¯ç”±ï¼Œä¸€ä¸ª server å—å¯ä»¥åŒ…å«å¤šä¸ª location å—ï¼Œæ¯ä¸ª</span></span><br><span class="line">    <span class="comment"># location å—å°±æ˜¯ä¸€ä¸ªè¯·æ±‚è·¯ç”±</span></span><br><span class="line">    <span class="comment"># location å—çš„æ ¼å¼æ˜¯ï¼š</span></span><br><span class="line">    <span class="comment"># location [=|~|~*|^~] /uri/ &#123; ... &#125;</span></span><br><span class="line">    <span class="comment"># = è¡¨ç¤ºç²¾ç¡®åŒ¹é…ï¼Œåªæœ‰å®Œå…¨åŒ¹é…ä¸Šæ‰èƒ½ç”Ÿæ•ˆ</span></span><br><span class="line">    <span class="comment"># ~ è¡¨ç¤ºåŒºåˆ†å¤§å°å†™çš„æ­£åˆ™åŒ¹é…</span></span><br><span class="line">    <span class="comment"># ~* è¡¨ç¤ºä¸åŒºåˆ†å¤§å°å†™çš„æ­£åˆ™åŒ¹é…</span></span><br><span class="line">    <span class="comment"># ^~ è¡¨ç¤ºæ™®é€šå­—ç¬¦åŒ¹é…ï¼Œå¦‚æœåŒ¹é…æˆåŠŸï¼Œåˆ™ä¸å†åŒ¹é…å…¶ä»– location</span></span><br><span class="line">    <span class="comment"># /uri/ è¡¨ç¤ºè¯·æ±‚çš„ URIï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯æ­£åˆ™è¡¨è¾¾å¼</span></span><br><span class="line">    <span class="comment"># &#123; ... &#125; è¡¨ç¤º location å—çš„é…ç½®å†…å®¹</span></span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="comment"># root æŒ‡ä»¤ç”¨äºæŒ‡å®šè¯·æ±‚çš„æ ¹ç›®å½•ï¼Œå¯ä»¥æ˜¯ç»å¯¹è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„</span></span><br><span class="line">        <span class="attribute">root</span> /usr/share/nginx/html; <span class="comment"># æ ¹ç›®å½•</span></span><br><span class="line">        <span class="comment"># index æŒ‡ä»¤ç”¨äºæŒ‡å®šé»˜è®¤æ–‡ä»¶ï¼Œå¦‚æœè¯·æ±‚çš„æ˜¯ç›®å½•ï¼Œåˆ™ä¼šåœ¨ç›®å½•ä¸‹æŸ¥æ‰¾é»˜è®¤æ–‡ä»¶</span></span><br><span class="line">        <span class="attribute">index</span> index.html index.htm; <span class="comment"># é»˜è®¤æ–‡ä»¶</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¸‹é¢æ˜¯ä¸€äº› location çš„ç¤ºä¾‹ï¼š</span></span><br><span class="line">    <span class="section">location</span> = / &#123; <span class="comment"># ç²¾ç¡®åŒ¹é…è¯·æ±‚</span></span><br><span class="line">        <span class="attribute">root</span> /usr/share/nginx/html;</span><br><span class="line">        <span class="attribute">index</span> index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">location</span><span class="regexp"> ^~</span> /images/ &#123; <span class="comment"># åŒ¹é…ä»¥/images/å¼€å¤´çš„è¯·æ±‚</span></span><br><span class="line">        <span class="attribute">root</span> /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">location</span> <span class="regexp">~* \.(gif|jpg|jpeg)$</span> &#123; <span class="comment"># åŒ¹é…ä»¥ gifã€jpg æˆ–è€… jpeg ç»“å°¾çš„è¯·æ±‚</span></span><br><span class="line">        <span class="attribute">root</span> /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">location</span> !<span class="regexp">~ \.(gif|jpg|jpeg)$</span> &#123; <span class="comment"># ä¸åŒ¹é…ä»¥ gifã€jpg æˆ–è€… jpeg ç»“å°¾çš„è¯·æ±‚</span></span><br><span class="line">        <span class="attribute">root</span> /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">location</span> !<span class="regexp">~* \.(gif|jpg|jpeg)$</span> &#123; <span class="comment"># ä¸åŒ¹é…ä»¥ gifã€jpg æˆ–è€… jpeg ç»“å°¾çš„è¯·æ±‚</span></span><br><span class="line">        <span class="attribute">root</span> /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># error_page ç”¨äºæŒ‡å®šé”™è¯¯é¡µé¢ï¼Œå¯ä»¥æŒ‡å®šå¤šä¸ªï¼ŒæŒ‰ç…§ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ä¾æ¬¡æŸ¥æ‰¾</span></span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> /50x.html; <span class="comment"># é”™è¯¯é¡µé¢</span></span><br><span class="line">    <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">        <span class="attribute">root</span> /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">nginx <span class="comment"># å¯åŠ¨ Nginx</span></span><br><span class="line">nginx -c filename <span class="comment"># æŒ‡å®šé…ç½®æ–‡ä»¶</span></span><br><span class="line">nginx -V <span class="comment"># æŸ¥çœ‹ Nginx çš„ç‰ˆæœ¬å’Œç¼–è¯‘å‚æ•°ç­‰ä¿¡æ¯</span></span><br><span class="line">nginx -t <span class="comment"># æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®ï¼Œä¹Ÿå¯ç”¨æ¥å®šä½é…ç½®æ–‡ä»¶çš„ä½ç½®</span></span><br><span class="line">nginx -s quit <span class="comment"># ä¼˜é›…åœæ­¢ Nginx</span></span><br><span class="line">nginx -s stop <span class="comment"># å¿«é€Ÿåœæ­¢ Nginx</span></span><br><span class="line">nginx -s reload <span class="comment"># çƒ­å¯åŠ¨ï¼Œé‡æ–°åŠ è½½é…ç½®æ–‡ä»¶</span></span><br><span class="line">nginx -s reopen <span class="comment"># é‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶</span></span><br></pre></td></tr></table></figure>

<h3 id="å¸¸ç”¨æ¨¡å—"><a href="#å¸¸ç”¨æ¨¡å—" class="headerlink" title="å¸¸ç”¨æ¨¡å—"></a>å¸¸ç”¨æ¨¡å—</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx -V</span></span><br><span class="line">nginx version: nginx/1.25.5</span><br><span class="line">built by gcc 12.2.0 (Debian 12.2.0-14) </span><br><span class="line">built with OpenSSL 3.0.9 30 May 2023 (running with OpenSSL 3.0.11 19 Sep 2023)</span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix =/etc/nginx --sbin-path =/usr/sbin/nginx --modules-path =/usr/lib/nginx/modules --conf-path =/etc/nginx/nginx.conf --error-log-path =/var/log/nginx/error.log --http-log-path =/var/log/nginx/access.log --pid-path =/var/run/nginx.pid --lock-path =/var/run/nginx.lock --http-client-body-temp-path =/var/cache/nginx/client_temp --http-proxy-temp-path =/var/cache/nginx/proxy_temp --http-fastcgi-temp-path =/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path =/var/cache/nginx/uwsgi_temp --http-scgi-temp-path =/var/cache/nginx/scgi_temp --user = nginx --group = nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-http_v3_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt =<span class="string">&#x27;-g -O2 -ffile-prefix-map =/data/builder/debuild/nginx-1.25.5/debian/debuild-base/nginx-1.25.5 =. -fstack-protector-strong -Wformat -Werror = format-security -Wp,-D_FORTIFY_SOURCE = 2 -fPIC&#x27;</span> --with-ld-opt =<span class="string">&#x27;-Wl,-z, relro -Wl,-z, now -Wl,--as-needed -pie&#x27;</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>æ¨¡å—åï¼ˆModule Nameï¼‰</th>
<th>æè¿°ï¼ˆDescriptionï¼‰</th>
</tr>
</thead>
<tbody><tr>
<td>http_access_module</td>
<td>æ¥å—æˆ–æ‹’ç»ç‰¹å®šçš„å®¢æˆ·ç«¯è¯·æ±‚</td>
</tr>
<tr>
<td><strong>http_auth_request_module</strong></td>
<td>æ ¹æ®å­è¯·æ±‚çš„ç»“æœå®ç°å®¢æˆ·ç«¯æˆæƒ</td>
</tr>
<tr>
<td>http_auth_basic_module</td>
<td>ä½¿ç”¨ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œ HTTP åŸºæœ¬è®¤è¯ï¼Œé™åˆ¶å¯¹èµ„æºçš„è®¿é—®</td>
</tr>
<tr>
<td>http_autoindex_module</td>
<td>è‡ªåŠ¨ç”Ÿæˆç›®å½•åˆ—è¡¨</td>
</tr>
<tr>
<td>http_browser_module</td>
<td>ä» User-Agent è¯·æ±‚å¤´ä¸­è¯†åˆ«å®¢æˆ·ç«¯æµè§ˆå™¨</td>
</tr>
<tr>
<td>http_charset_module</td>
<td>ä¸º Content-Type å“åº”å¤´æ·»åŠ ç‰¹å®šå­—ç¬¦é›†</td>
</tr>
<tr>
<td>http_empty_gif_module</td>
<td>è¿”å›ä¸€ä¸ª 1 åƒç´ çš„é€æ˜ GIF å›¾ç‰‡</td>
</tr>
<tr>
<td>http_fastcgi_module</td>
<td>æä¾› FastCGI æ”¯æŒ</td>
</tr>
<tr>
<td>http_geo_module</td>
<td>æ ¹æ® IP åœ°å€è·å–åœ°ç†ä½ç½®ä¿¡æ¯</td>
</tr>
<tr>
<td>http_gzip_module</td>
<td>æ”¯æŒ Gzip å‹ç¼©</td>
</tr>
<tr>
<td>http_limit_conn_module</td>
<td>é™åˆ¶å¹¶å‘è¿æ¥æ•°</td>
</tr>
<tr>
<td>http_limit_req_module</td>
<td>é™åˆ¶è¯·æ±‚é€Ÿç‡</td>
</tr>
<tr>
<td>http_map_module</td>
<td>åŸºäºå˜é‡æ˜ å°„è·å–å€¼</td>
</tr>
<tr>
<td>http_memcached_module</td>
<td>æä¾› Memcached æ”¯æŒ</td>
</tr>
<tr>
<td>http_proxy_module</td>
<td>æä¾›åå‘ä»£ç†æ”¯æŒ</td>
</tr>
<tr>
<td>http_referer_module</td>
<td>é˜²æ­¢ç›—é“¾</td>
</tr>
<tr>
<td>http_rewrite_module</td>
<td>æ”¯æŒ URL é‡å†™</td>
</tr>
<tr>
<td>http_scgi_module</td>
<td>å°†è¯·æ±‚è½¬å‘åˆ° SCGI æœåŠ¡å™¨</td>
</tr>
<tr>
<td>http_ssi_module</td>
<td>å¤„ç†å’Œæ”¯æŒ SSIï¼ˆæœåŠ¡å™¨ç«¯åŒ…å«ï¼‰</td>
</tr>
<tr>
<td>http_split_clients_module</td>
<td>æ ¹æ®å®¢æˆ·ç«¯ IP åœ°å€æˆ–å…¶ä»–å˜é‡å°†å®¢æˆ·ç«¯åˆ†ç»„ï¼Œé€šå¸¸ç”¨äº A&#x2F;B æµ‹è¯•</td>
</tr>
<tr>
<td>http_upstream_hash_module</td>
<td>æä¾›ä¸€è‡´æ€§å“ˆå¸Œè´Ÿè½½å‡è¡¡</td>
</tr>
<tr>
<td>http_upstream_ip_hash_module</td>
<td>æä¾› IP å“ˆå¸Œè´Ÿè½½å‡è¡¡</td>
</tr>
<tr>
<td>http_upstream_keepalive_module</td>
<td>æ”¯æŒé•¿è¿æ¥è´Ÿè½½å‡è¡¡</td>
</tr>
<tr>
<td>http_upstream_least_conn_module</td>
<td>æä¾›æœ€å°‘è¿æ¥è´Ÿè½½å‡è¡¡</td>
</tr>
<tr>
<td>http_upstream_zone_module</td>
<td>æä¾›å…±äº«å†…å­˜è´Ÿè½½å‡è¡¡</td>
</tr>
<tr>
<td>http_userid_module</td>
<td>ä¸ºå®¢æˆ·ç«¯è®¾ç½®å”¯ä¸€çš„ IDï¼ˆUIDã€cookieï¼‰</td>
</tr>
<tr>
<td>http_uwsgi_module</td>
<td>å°†è¯·æ±‚è½¬å‘åˆ° uWSGI æœåŠ¡å™¨ï¼Œé€šå¸¸ç”¨äº Python åº”ç”¨</td>
</tr>
</tbody></table>
<h2 id="ç»Ÿä¸€é‰´æƒ"><a href="#ç»Ÿä¸€é‰´æƒ" class="headerlink" title="ç»Ÿä¸€é‰´æƒ"></a>ç»Ÿä¸€é‰´æƒ</h2><p>å¼‚æ„çš„åç«¯æœåŠ¡ï¼Œä½¿ç”¨ API ç½‘å…³ç»Ÿä¸€é‰´æƒ</p>
<ul>
<li>å®¢æˆ·ç«¯è¯·æ±‚: å®¢æˆ·ç«¯è¯·æ±‚ API ç½‘å…³ï¼Œé™„å¸¦ JWT</li>
<li>APIç½‘å…³é‰´æƒ: API ç½‘å…³éªŒè¯JWTçš„æœ‰æ•ˆæ€§å’Œæƒé™<strong>ï¼ˆæ‰©å±•åšé™æµï¼‰</strong></li>
<li>è½¬å‘è¯·æ±‚: å¦‚æœ JWT æœ‰æ•ˆï¼ŒAPI ç½‘å…³å°†è¯·æ±‚è½¬å‘ç»™ç›¸åº”çš„åç«¯æœåŠ¡<strong>ï¼ˆè¿˜å¯ä»¥æ·»åŠ ä¸€äº›å¤´éƒ¨ä¿¡æ¯ï¼‰</strong></li>
<li>åç«¯æœåŠ¡å“åº”: åç«¯æœåŠ¡å¤„ç†è¯·æ±‚å¹¶è¿”å›å“åº”ï¼ŒAPI ç½‘å…³å°†å“åº”è¿”å›ç»™å®¢æˆ·ç«¯</li>
</ul>
<div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hcjjj/blog-img/20240805165418.png" fancybox="true"/></div></div>

<p>é€šè¿‡å°† NGINX ä½œä¸ºåå‘ä»£ç†å’Œ API ç½‘å…³ï¼Œå¯ä»¥åœ¨ NGINX å±‚é¢é›†ä¸­å¤„ç†æ‰€æœ‰çš„èº«ä»½éªŒè¯å’Œæˆæƒé€»è¾‘ï¼Œå¦‚æœéªŒè¯é€šè¿‡ï¼ŒNginx å°†è¯·æ±‚è½¬å‘åˆ°ç›¸åº”çš„åç«¯æœåŠ¡ï¼›å¦‚æœéªŒè¯å¤±è´¥ï¼Œè¿”å› 401 æœªæˆæƒé”™è¯¯ã€‚å°†é‰´æƒé€»è¾‘å¤–åŒ…ç»™ä¸“é—¨çš„é‰´æƒæœåŠ¡ï¼Œæ–¹ä¾¿ç®¡ç†å’Œæ‰©å±•ã€‚</p>
<ul>
<li><p>é‰´æƒæœåŠ¡åœ°å€ï¼š<a target="_blank" rel="noopener" href="http://127.0.0.1:7777/api/auth">http://127.0.0.1:7777/api/auth</a> ï¼ˆéƒ¨ç½²åœ¨æœ¬åœ°çš„ Docker å®¹å™¨ï¼‰</p>
</li>
<li><p>åç«¯åº”ç”¨æœåŠ¡ï¼š<a target="_blank" rel="noopener" href="http://127.0.0.1:8888/">http://127.0.0.1:8888</a> ï¼ˆç›´æ¥æœ¬åœ°è¿è¡Œçš„åç«¯åº”ç”¨ï¼‰</p>
</li>
<li><p>è½¬å‘å’Œé‰´æƒé…ç½®ï¼š</p>
</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å†…éƒ¨é‰´æƒä½ç½®ï¼Œä¸è¦å¯¹å¤–æš´éœ²</span></span><br><span class="line">    <span class="section">location</span> = /auth-internal &#123;</span><br><span class="line">        internal;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://host.docker.internal: <span class="number">7777</span>/api/auth;</span><br><span class="line">        <span class="attribute">proxy_intercept_errors</span> <span class="literal">on</span>; <span class="comment"># ç¡®ä¿æ‹¦æˆªé”™è¯¯</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># è‡ªå®šä¹‰ 401 é”™è¯¯å“åº”</span></span><br><span class="line">    <span class="attribute">error_page</span> <span class="number">401</span> = <span class="variable">@auth_error</span>;</span><br><span class="line">    <span class="section">location</span> <span class="variable">@auth_error</span> &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">401</span> Unauthorize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># éœ€è¦é‰´æƒçš„è¯·æ±‚</span></span><br><span class="line">    <span class="section">location</span> /api/payment/ &#123;</span><br><span class="line">        <span class="comment"># ä½¿ç”¨ http_auth_request_module é‰´æƒ</span></span><br><span class="line">        <span class="attribute">auth_request</span> /auth-internal;</span><br><span class="line">        <span class="comment"># å¦‚æœé‰´æƒé€šè¿‡ï¼Œè®¾ç½®è¯·æ±‚å¤´</span></span><br><span class="line">        <span class="attribute">auth_request_set</span> <span class="variable">$user_role</span> $ upstream_http_x_user_role;</span><br><span class="line">        <span class="attribute">auth_request_set</span> <span class="variable">$user_id</span> $ upstream_http_x_user_id;</span><br><span class="line">        <span class="comment"># è®¾ç½®é‰´æƒé€šè¿‡åçš„è‡ªå®šä¹‰å¤´éƒ¨</span></span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-User-Role <span class="variable">$user_role</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-User-ID <span class="variable">$user_id</span>;</span><br><span class="line">        <span class="comment"># è½¬å‘åˆ°åç«¯æœåŠ¡</span></span><br><span class="line">        <span class="attribute">proxy_pass</span> http://host.docker.internal: <span class="number">8888</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hcjjj/blog-img/20240806160759.png" fancybox="true"/></div></div>

<h2 id="é‰´æƒæœåŠ¡"><a href="#é‰´æƒæœåŠ¡" class="headerlink" title="é‰´æƒæœåŠ¡"></a>é‰´æƒæœåŠ¡</h2><h3 id="JWT-æ ¡éªŒ"><a href="#JWT-æ ¡éªŒ" class="headerlink" title="JWT æ ¡éªŒ"></a>JWT æ ¡éªŒ</h3><p>ç”¨æˆ·æœåŠ¡åš JWT çš„ç­¾å‘ä¸æ³¨é”€ï¼ˆéœ€è¦ä¾èµ–ç¬¬ä¸‰æ–¹ç»„ä»¶åšè®°å½•ï¼Œå¦‚ Redisï¼‰</p>
<p>è¯·æ±‚ä¸å¸¦ JWT  æˆ–  JWT æ ¡éªŒå¤±è´¥ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$hcjjj</span>: ~ â¯ curl -i http://127.0.0.1:7777/api/auth                                                       </span><br><span class="line">HTTP/1.1 401 Unauthorized</span><br><span class="line">Access-Control-Allow-Headers: Content-Type, Origin, X-CSRF-Token, Authorization, AccessToken, Token, Range</span><br><span class="line">Access-Control-Allow-Methods: GET, HEAD, POST, PATCH, PUT, DELETE</span><br><span class="line">Access-Control-Allow-Origin: *</span><br><span class="line">Access-Control-Expose-Headers: Content-Length, Access-Control-Allow-Origin, Access-Control-Allow-Headers</span><br><span class="line">Access-Control-Max-Age: 86400</span><br><span class="line">Content-Type: text/plain; charset = utf-8</span><br><span class="line">Traceparent: 00-229a8d047c093eb9637d020dd9471d3a-b59927828a3f7d87-00</span><br><span class="line">Vary: Origin</span><br><span class="line">X-Content-Type-Options: nosniff</span><br><span class="line">Date: Mon, 05 Aug 2024 11:42:26 GMT</span><br><span class="line">Content-Length: 13</span><br><span class="line"></span><br><span class="line">Unauthorized</span><br></pre></td></tr></table></figure>

<p>è¯·æ±‚å¸¦æ­£ç¡®çš„ JWT ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$hcjjj</span>: ~ â¯ curl -H <span class="string">&quot; Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI1IiwidHlwZSI6IkFDQ0VTU19UT0tFTiIsInJvbGUiOiJVU0VSIiwiZXhwIjoxNzI1Njc3NjEzLCJpYXQiOjE3MjA0OTM2MTN9.Z0CXV0B-7USnB6VhHRT4RsN3lxv11R_5h7wxvGoeoLQ &quot;</span>  -i http://127.0.0.1:7777/api/auth</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Access-Control-Allow-Headers: Content-Type, Origin, X-CSRF-Token, Authorization, AccessToken, Token, Range</span><br><span class="line">Access-Control-Allow-Methods: GET, HEAD, POST, PATCH, PUT, DELETE</span><br><span class="line">Access-Control-Allow-Origin: *</span><br><span class="line">Access-Control-Expose-Headers: Content-Length, Access-Control-Allow-Origin, Access-Control-Allow-Headers</span><br><span class="line">Access-Control-Max-Age: 86400</span><br><span class="line">Traceparent: 00-02f50d29723ccdd50dfab510b294e763-17fb6226dc8b5e07-00</span><br><span class="line">Vary: Origin</span><br><span class="line">X-User-Id: 5</span><br><span class="line">X-User-Role: USER</span><br><span class="line">Date: Mon, 05 Aug 2024 11:43:47 GMT</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡é‰´æƒçš„è¯·æ±‚ä¼šåœ¨å…¶å¤´éƒ¨æ·»åŠ  user_idã€user_roleã€user_uuid å­—æ®µï¼Œé€»è¾‘ä¸ºï¼š</p>
<p>é‰´æƒæœåŠ¡ â¡ï¸ Nginx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> permission &#123;</span><br><span class="line">    // é‰´æƒé€šè¿‡çš„è¯ï¼Œè®¾ç½®è‡ªå®šä¹‰å¤´éƒ¨ï¼Œç»™åˆ° Nginxï¼Œåç»­å†è½¬å‘åˆ°å¯¹åº”çš„æœåŠ¡</span><br><span class="line">    w.Header().Set(<span class="string">&quot;X-User-ID&quot;</span>, userId)</span><br><span class="line">    w.Header().Set(<span class="string">&quot;X-User-Role&quot;</span>, userInfo.Role)</span><br><span class="line">    w.Header().Set(<span class="string">&quot;X-User-UUID&quot;</span>, userInfo.Uuid)</span><br><span class="line">    // è¿”å› 200 OK</span><br><span class="line">    w.WriteHeader(http.StatusOK)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    http.Error(w, <span class="string">&quot;Unauthorized&quot;</span>, http.StatusUnauthorized)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Nginx  â¡ï¸ å¯¹åº”æœåŠ¡</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># éœ€è¦é‰´æƒçš„è¯·æ±‚</span></span><br><span class="line"><span class="string">location</span> <span class="string">/api/payment/</span> &#123;</span><br><span class="line">    <span class="comment"># ä½¿ç”¨ http_auth_request_module é‰´æƒ</span></span><br><span class="line">    <span class="string">auth_request</span> <span class="string">/auth-internal;</span></span><br><span class="line">    <span class="comment"># ä»é‰´æƒæœåŠ¡çš„å“åº”ä¸­æå–åä¸º X-User-Role çš„å¤´éƒ¨ï¼Œå¹¶å°†å…¶å€¼èµ‹ç»™å˜é‡ $user_role</span></span><br><span class="line">    <span class="string">auth_request_set</span> <span class="string">$user_role</span> <span class="string">$</span> <span class="string">upstream_http_x_user_role;</span></span><br><span class="line">    <span class="string">auth_request_set</span> <span class="string">$user_id</span> <span class="string">$</span> <span class="string">upstream_http_x_user_id;</span></span><br><span class="line">    <span class="string">auth_request_set</span> <span class="string">$user_uuid</span> <span class="string">$</span> <span class="string">upstream_http_x_user_uuid;</span></span><br><span class="line">    <span class="comment"># è®¾ç½®é‰´æƒæœåŠ¡æ ¡éªŒé€šè¿‡åçš„ user_role user_id å’Œ user_uuid åˆ°åŸå§‹è¯·æ±‚ä¸­</span></span><br><span class="line">    <span class="string">proxy_set_header</span> <span class="string">X-User-Role</span> <span class="string">$user_role;</span></span><br><span class="line">    <span class="string">proxy_set_header</span> <span class="string">X-User-ID</span> <span class="string">$user_id;</span></span><br><span class="line">    <span class="string">proxy_set_header</span> <span class="string">X-User-UUID</span> <span class="string">$user_uuid;</span></span><br><span class="line">    <span class="comment"># è½¬å‘åˆ°åç«¯æœåŠ¡</span></span><br><span class="line">    <span class="attr">proxy_pass http://host.docker.internal:</span> <span class="number">8888</span><span class="string">;</span></span><br><span class="line">    <span class="comment"># proxy_pass https://prod.creaibo.com;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>JWTé€€å‡ºæœºåˆ¶ï¼šä½¿ç”¨ Redis è®°å½•å·²é€€å‡ºçš„ JWTï¼Œæ¯æ¬¡æ ¡éªŒçš„æ—¶å€™æ£€æŸ¥ä¸€ä¸‹ JWT æ˜¯å¦åœ¨é»‘åå•ä¸­ï¼Œè¿‡æœŸæ—¶é—´ä¸ JWT ä¿å­˜ä¸€è‡´</p>
</blockquote>
<h3 id="è¯·æ±‚é™æµ"><a href="#è¯·æ±‚é™æµ" class="headerlink" title="è¯·æ±‚é™æµ"></a>è¯·æ±‚é™æµ</h3><p>[åŸºäº IP çš„é™æµæ£€æŸ¥] â¡ï¸ [JWT ç™»å½•æ ¡éªŒ] â¡ï¸ [RBAC æƒé™æ£€æŸ¥] â¡ï¸ [å†™å…¥ç›¸å…³ä¿¡æ¯åˆ°è¯·æ±‚å¤´å¹¶è½¬å‘è‡³å¯¹äºåç«¯æœåŠ¡]</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ ¹æ® IP åšé™æµæ£€æŸ¥</span></span><br><span class="line">limited, err := svc.RateLimiter.LimitDefault(context.Background(), GenLimiterKey(r))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    http.Error(w, <span class="string">&quot;Internal Server Error&quot;</span>, http.StatusInternalServerError)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> limited &#123;</span><br><span class="line">    http.Error(w, <span class="string">&quot;Forbidden&quot;</span>, http.StatusForbidden)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RBAC-é‰´æƒ"><a href="#RBAC-é‰´æƒ" class="headerlink" title="RBAC é‰´æƒ"></a>RBAC é‰´æƒ</h3><p>Nginx é…ç½®</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">location</span> <span class="string">=</span> <span class="string">/auth-internal</span> &#123;</span><br><span class="line">    <span class="string">internal;</span></span><br><span class="line">    <span class="comment"># è®¾ç½®ä»£ç†è¯·æ±‚å¤´ä»¥åŒ…å«åŸå§‹å®¢æˆ·ç«¯ IP å’Œ URL ä¿¡æ¯, Method ä¿¡æ¯</span></span><br><span class="line">    <span class="string">proxy_set_header</span> <span class="string">X-Original-IP</span> <span class="string">$remote_addr;</span></span><br><span class="line">    <span class="string">proxy_set_header</span> <span class="string">X-Original-URI</span> <span class="string">$request_uri;</span></span><br><span class="line">    <span class="string">proxy_set_header</span> <span class="string">X-Original-Method</span> <span class="string">$request_method;</span></span><br><span class="line">    <span class="attr">proxy_pass http://host.docker.internal:</span> <span class="number">7777</span><span class="string">/api/auth;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>è·å–è¯·æ±‚çš„é‰´æƒä¿¡æ¯</li>
<li>æ ¹æ® [ç”¨æˆ·IDï¼ŒåŸå§‹ URLï¼ŒMethod] è¿›è¡Œæ¥å£æƒé™çš„æ£€æŸ¥</li>
<li><strong>ç™½åå•æ¨¡å¼</strong>ï¼Œéœ€è¦å¯¹ç³»ç»Ÿæ¥å£è¿›è¡Œæ¢³ç†å’Œé…ç½®ï¼ˆåç»­å¯æ‰©å±•ä¸ºæ­£åˆ™è¡¨è¾¾å¼æˆ–é€šé…ç¬¦æ¨¡å¼ï¼‰</li>
</ol>
<h2 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h2><div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hcjjj/blog-img/Untitled%20diagram-2024-08-06-072719.png" fancybox="true"/></div></div>

<p><strong>Ingress</strong> æ˜¯å¯¹é›†ç¾¤ä¸­æœåŠ¡çš„å¤–éƒ¨è®¿é—®è¿›è¡Œç®¡ç†çš„ API å¯¹è±¡ï¼ŒIngresså¯ä»¥æä¾›ç»Ÿä¸€çš„å…¥å£æ§åˆ¶ã€HTTP&#x2F;HTTPSè·¯ç”±ã€SSLç»ˆæ­¢å’Œè´Ÿè½½å‡è¡¡ç­‰åŠŸèƒ½ã€‚å¦‚é€šè¿‡ Ingress èµ„æºæ¥é…ç½®ä¸åŒçš„è½¬å‘è§„åˆ™ï¼Œä»è€Œè¾¾åˆ°<strong>æ ¹æ®ä¸åŒçš„è§„åˆ™è®¾ç½®è®¿é—®é›†ç¾¤å†…ä¸åŒçš„ Service æ‰€å¯¹åº”çš„åç«¯ Pod</strong>ã€‚</p>
<blockquote>
<p>APIå¯¹è±¡ï¼ˆApplication Programming Interface Objectï¼‰é€šå¸¸æŒ‡çš„æ˜¯åœ¨è½¯ä»¶ç³»ç»Ÿä¸­å®šä¹‰çš„ä¸€ç»„æ¥å£å’Œåè®®ï¼Œå®ƒä»¬å…è®¸ä¸åŒçš„è½¯ä»¶åº”ç”¨ç¨‹åºä¹‹é—´è¿›è¡Œäº¤äº’ã€‚APIå¯¹è±¡å¯ä»¥æ˜¯æ•°æ®ç»“æ„ã€å‡½æ•°ã€ç±»æˆ–æœåŠ¡ï¼Œå®ƒä»¬æä¾›äº†ä¸€ç§æ ‡å‡†åŒ–çš„æ–¹æ³•æ¥è®¿é—®ä¸€ä¸ªåº”ç”¨ç¨‹åºæˆ–æœåŠ¡çš„åŠŸèƒ½æˆ–æ•°æ®ã€‚</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/ingress-nginx">Nginx Ingress Controller</a> æ˜¯ Kubernetes ç”Ÿæ€ç³»ç»Ÿä¸­å¹¿æ³›ä½¿ç”¨çš„ Ingress æ§åˆ¶å™¨ä¹‹ä¸€ï¼Œä¸Šæ–‡ç»Ÿä¸€é‰´æƒæ˜¯ç”¨ Nginx çš„ <strong>auth_request</strong> æ¨¡å—ï¼Œéƒ¨ç½²åœ¨ K8s çš„åéœ€è¦ä½¿ç”¨ Nginx Ingress Controller çš„ <strong>auth-url æ³¨è§£</strong>ï¼ˆ <a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#external-authentication">External Authentication</a> ï¼‰æˆ–æ’å…¥<strong>è‡ªå®šä¹‰ Nginx é…ç½®</strong>ï¼ˆ<a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#configuration-snippet">Configuration snippet</a>ï¼‰æ¥å®ç°ã€‚</p>
<div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hcjjj/blog-img/20240805165509.png" fancybox="true"/></div></div>

<h3 id="Nginx-Ingress"><a href="#Nginx-Ingress" class="headerlink" title="Nginx Ingress"></a>Nginx Ingress</h3><ol>
<li>å®‰è£… <a target="_blank" rel="noopener" href="https://helm.sh/">heml</a></li>
<li>å®‰è£… <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/tools/install-kubectl-linux/">Kubectl</a></li>
<li><code>kubectl</code> è¿æ¥é›†ç¾¤</li>
<li><code>helm</code> å®‰è£… ingress-nginx</li>
<li>ç‰ˆæœ¬ä¸å‡çº§ <a target="_blank" rel="noopener" href="https://github.com/kubernetes/ingress-nginx?tab=readme-ov-file#supported-versions-table">Supported Versions table</a></li>
<li>æ–°å»º <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a></li>
</ol>
<hr>
<ul>
<li><code>Ingress</code> çš„ <code>annotations</code> ä¸»è¦ç”¨äºé…ç½®å…¨å±€çš„è¡Œä¸ºå’Œç‰¹æ€§ï¼Œå¦‚è¶…æ—¶ã€é‡å†™è§„åˆ™ç­‰ï¼Œä½†ä¸èƒ½ç›´æ¥ä¿®æ”¹æˆ–æ’å…¥å¤æ‚çš„ <code>location</code> é…ç½®</li>
<li>ä½¿ç”¨ <code>nginx.ingress.kubernetes.io/server-snippet</code> å¯ä»¥æ·»åŠ å…¨å±€çš„è‡ªå®šä¹‰ <code>location</code> å—ï¼Œä½†ä¸èƒ½é’ˆå¯¹å•ä¸ªè·¯å¾„</li>
<li>ä½¿ç”¨ <code>nginx.ingress.kubernetes.io/location-snippet</code> å¯ä»¥é’ˆå¯¹ç‰¹å®šè·¯å¾„æ·»åŠ è‡ªå®šä¹‰çš„ <code>location</code> é…ç½®</li>
</ul>
<div class="tag-plugin image"><div class="image-bg"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="https://cdn.jsdelivr.net/gh/hcjjj/blog-img/20240808191113.png" fancybox="true"/></div></div>

<h3 id="ç›¸å…³æ‰©å±•"><a href="#ç›¸å…³æ‰©å±•" class="headerlink" title="ç›¸å…³æ‰©å±•"></a>ç›¸å…³æ‰©å±•</h3><p><strong>Kubernetes èµ„æºå¯¹è±¡</strong></p>
<ul>
<li>å®šä¹‰: Kubernetes èµ„æºå¯¹è±¡æ˜¯ Kubernetes é›†ç¾¤ä¸­ç”¨äºæè¿°å’Œç®¡ç†å„ç§èµ„æºçš„ API å¯¹è±¡ã€‚å®ƒä»¬å®šä¹‰äº†é›†ç¾¤ä¸­éœ€è¦è¿è¡Œå’Œç®¡ç†çš„æœåŠ¡ã€åº”ç”¨ç¨‹åºã€ç½‘ç»œã€å­˜å‚¨ç­‰ã€‚</li>
<li>ç§ç±»: åŒ…æ‹¬å¤šç§ç±»å‹ï¼Œå¦‚ <code>Pod</code>ã€<code>Service</code>ã€<code>Deployment</code>ã€<code>Ingress</code>ã€<code>ConfigMap</code>ã€<code>Secret</code>ã€<code>PersistentVolume</code> ç­‰ã€‚</li>
<li>åŠŸèƒ½: å®ƒä»¬ç”¨äºå£°æ˜å’Œç®¡ç†é›†ç¾¤ä¸­çš„èµ„æºçŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œ<code>Deployment</code> èµ„æºç”¨äºç®¡ç†åº”ç”¨çš„å‰¯æœ¬å’Œæ»šåŠ¨æ›´æ–°ï¼Œ<code>Service</code> èµ„æºç”¨äºå®šä¹‰æœåŠ¡çš„è®¿é—®æ–¹å¼ã€‚</li>
<li>è¿è¡Œæ–¹å¼: èµ„æºå¯¹è±¡æœ¬èº«ä¸ç›´æ¥è¿è¡Œåœ¨ Pod ä¸­ï¼Œå®ƒä»¬æ˜¯ Kubernetes é›†ç¾¤çš„é…ç½®å’Œç®¡ç†å•ä½ã€‚å®ƒä»¬é€šè¿‡ Kubernetes æ§åˆ¶å¹³é¢ï¼ˆæ§åˆ¶å™¨ï¼‰å’Œè°ƒåº¦å™¨æ¥ç®¡ç†é›†ç¾¤ä¸­çš„å®é™…å·¥ä½œè´Ÿè½½ã€‚</li>
</ul>
<p><strong>Pod</strong></p>
<ul>
<li>å®šä¹‰: <code>Pod</code> æ˜¯ Kubernetes ä¸­æœ€åŸºæœ¬çš„éƒ¨ç½²å•å…ƒï¼Œæ˜¯è¿è¡Œåœ¨é›†ç¾¤èŠ‚ç‚¹ä¸Šçš„ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„é›†åˆã€‚Pod æä¾›äº†å®¹å™¨è¿è¡Œæ—¶æ‰€éœ€çš„ç½‘ç»œå’Œå­˜å‚¨èµ„æºã€‚</li>
<li>åŠŸèƒ½: Pod æ˜¯å®é™…è¿è¡Œåº”ç”¨ç¨‹åºä»£ç çš„åœ°æ–¹ã€‚æ¯ä¸ª Pod åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ï¼Œè¿™äº›å®¹å™¨å…±äº«ç½‘ç»œå’Œå­˜å‚¨ã€‚Pod è¿˜å¯ä»¥åŒ…æ‹¬ Init å®¹å™¨ã€å­˜å‚¨å·ç­‰ã€‚</li>
<li>è¿è¡Œæ–¹å¼: Pod æ˜¯ Kubernetes é›†ç¾¤ä¸­çš„å®é™…å·¥ä½œè´Ÿè½½ï¼Œå®ƒä»¬è¢« Kubernetes è°ƒåº¦å™¨åˆ†é…åˆ°èŠ‚ç‚¹ä¸Šï¼Œå¹¶ç”±å®¹å™¨è¿è¡Œæ—¶ï¼ˆå¦‚ Dockerã€containerdï¼‰æ‰§è¡Œå®¹å™¨ã€‚Pod é€šè¿‡ Deploymentã€DaemonSet æˆ– StatefulSet ç­‰æ§åˆ¶å™¨è¿›è¡Œç®¡ç†å’Œè°ƒåº¦ã€‚</li>
</ul>
<p><strong>å…³ç³»</strong></p>
<ul>
<li>èµ„æºå¯¹è±¡ vs Pod: <code>Pod</code> æ˜¯ä¸€ç§ Kubernetes èµ„æºå¯¹è±¡ï¼ˆ<code>kind: Pod</code>ï¼‰ï¼Œå®ƒç”¨äºå®šä¹‰å’Œè¿è¡Œå®¹å™¨ã€‚å…¶ä»–èµ„æºå¯¹è±¡ï¼ˆå¦‚ <code>Deployment</code>ï¼‰ç”¨äºç®¡ç† Pod çš„ç”Ÿå‘½å‘¨æœŸã€‚èµ„æºå¯¹è±¡æä¾›äº†é›†ç¾¤çš„é…ç½®å’Œç®¡ç†åŠŸèƒ½ï¼Œè€Œ Pod æ˜¯å®é™…è¿è¡Œåº”ç”¨ç¨‹åºçš„å®ä½“ã€‚</li>
<li>ç®¡ç†: Kubernetes æ§åˆ¶å¹³é¢å’Œè°ƒåº¦å™¨ä½¿ç”¨èµ„æºå¯¹è±¡æ¥ç®¡ç†å’Œè°ƒåº¦ Podã€‚é€šè¿‡åˆ›å»ºå’Œæ›´æ–°èµ„æºå¯¹è±¡ï¼Œç”¨æˆ·å¯ä»¥æ§åˆ¶ Pod çš„éƒ¨ç½²ã€æ‰©å±•ã€æ›´æ–°ç­‰æ“ä½œã€‚</li>
</ul>
<p><strong>Ingress èµ„æº</strong></p>
<ul>
<li><p>å®šä¹‰: <code>Ingress</code> æ˜¯ Kubernetes çš„ä¸€ä¸ªæ ‡å‡† API èµ„æºï¼Œç”¨äºç®¡ç†é›†ç¾¤å¤–éƒ¨è®¿é—®æœåŠ¡çš„è·¯ç”±è§„åˆ™ã€‚</p>
</li>
<li><p>åŠŸèƒ½: å®ƒå®šä¹‰äº†å¦‚ä½•å°† HTTP å’Œ HTTPS è¯·æ±‚è·¯ç”±åˆ°é›†ç¾¤å†…éƒ¨çš„æœåŠ¡ã€‚é€šè¿‡ <code>Ingress</code> èµ„æºï¼Œå¯ä»¥æŒ‡å®šè·¯å¾„ã€ä¸»æœºã€è¯ä¹¦ç­‰ä¿¡æ¯ã€‚</p>
</li>
<li><p>å®ç°: <code>Ingress</code> å¯ä»¥ç”±ä¸åŒçš„æ§åˆ¶å™¨æ¥å®ç°ï¼ŒåŒ…æ‹¬ Nginxã€Traefikã€HAProxyã€Istio ç­‰ã€‚å…·ä½“çš„åŠŸèƒ½å’Œé…ç½®ä¼šä¾èµ–äºä½ ä½¿ç”¨çš„ <code>Ingress</code> æ§åˆ¶å™¨ã€‚</p>
</li>
<li><p>è¿è¡Œ: <code>Ingress</code> æœ¬èº«ä¸æ˜¯ä¸€ä¸ªè¿è¡Œä¸­çš„ç»„ä»¶ï¼Œå®ƒåªæ˜¯ä¸€ä¸ª Kubernetes èµ„æºå¯¹è±¡ã€‚å®ƒå®šä¹‰äº†è·¯ç”±è§„åˆ™ã€ä¸»æœºã€è·¯å¾„ç­‰ï¼Œæ§åˆ¶å¦‚ä½•å°†è¯·æ±‚è½¬å‘åˆ°æœåŠ¡ã€‚</p>
<p>éƒ¨ç½²: ä½ é€šè¿‡ <code>kubectl apply</code> å‘½ä»¤åˆ›å»ºæˆ–æ›´æ–° <code>Ingress</code> èµ„æºï¼Œå®ƒä¼šè¢« Kubernetes æ§åˆ¶å¹³é¢ç®¡ç†ï¼Œå¹¶ä¸ç›¸åº”çš„ Ingress æ§åˆ¶å™¨ä¸€èµ·å·¥ä½œã€‚</p>
</li>
</ul>
<p><strong>NginxIngress æ§åˆ¶å™¨</strong></p>
<ul>
<li>å®šä¹‰: <code>NginxIngress</code> æ§åˆ¶å™¨ï¼ˆå³ <code>Ingress-Nginx</code> æ§åˆ¶å™¨ï¼‰æ˜¯å®ç° <code>Ingress</code> èµ„æºçš„å…·ä½“æ–¹æ¡ˆä¹‹ä¸€ã€‚</li>
<li>åŠŸèƒ½: å®ƒä½¿ç”¨ Nginx ä½œä¸ºåå‘ä»£ç†æœåŠ¡å™¨ï¼Œå°†å¤–éƒ¨è¯·æ±‚æ ¹æ® <code>Ingress</code> è§„åˆ™è½¬å‘åˆ°é›†ç¾¤å†…éƒ¨çš„æœåŠ¡ã€‚å®ƒæä¾›äº†è®¸å¤šé«˜çº§åŠŸèƒ½ï¼Œå¦‚è‡ªå®šä¹‰ Nginx é…ç½®ã€TLS ç»ˆæ­¢ã€è·¯å¾„é‡å†™ç­‰ã€‚</li>
<li>é…ç½®: <code>Ingress-Nginx</code> æ§åˆ¶å™¨é€šå¸¸é€šè¿‡ <code>ConfigMap</code>ã€<code>Ingress</code> æ³¨è§£ç­‰æ–¹å¼è¿›è¡Œé…ç½®ã€‚å®ƒè¿˜å…è®¸ä½¿ç”¨æ³¨è§£æ¥ä¿®æ”¹æˆ–æ‰©å±• Nginx çš„è¡Œä¸ºã€‚</li>
<li>è¿è¡Œ: <code>NginxIngress</code> æ§åˆ¶å™¨è¿è¡Œåœ¨ Kubernetes é›†ç¾¤ä¸­çš„ Pod ä¸­ã€‚å®ƒé€šå¸¸æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ª Pod çš„é›†åˆï¼Œè¿™äº› Pod è¿è¡Œç€ Nginx å®ä¾‹ï¼Œè´Ÿè´£æ ¹æ® <code>Ingress</code> èµ„æºçš„è§„åˆ™å¤„ç†å’Œè·¯ç”±æµé‡ã€‚</li>
<li>éƒ¨ç½²: <code>Ingress-Nginx</code> æ§åˆ¶å™¨ä½œä¸º Kubernetes çš„ Deployment æˆ– DaemonSet éƒ¨ç½²ï¼Œé€šå¸¸ä¼šåœ¨ <code>kube-system</code> å‘½åç©ºé—´ä¸­æˆ–å…¶ä»–æŒ‡å®šçš„å‘½åç©ºé—´ä¸­è¿è¡Œã€‚</li>
</ul>
<p><strong>å…³ç³»</strong></p>
<ul>
<li>Ingress Controller æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ Kubernetes é›†ç¾¤ä¸­çš„åº”ç”¨ç¨‹åºï¼Œå®ƒè´Ÿè´£å®ç° Ingress èµ„æºå®šä¹‰çš„è§„åˆ™ã€‚å®ƒç›‘å¬ Ingress èµ„æºçš„å˜åŒ–ï¼Œå¹¶æ ¹æ®è¿™äº›å˜åŒ–æ¥é…ç½®è‡ªå·±çš„è´Ÿè½½å‡è¡¡å’ŒæœåŠ¡è·¯ç”±è§„åˆ™ã€‚ä½ æä¾›çš„ Service é…ç½®æ˜¯ NGINX Ingress Controller çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒä½œä¸ºæœåŠ¡è¿è¡Œåœ¨é›†ç¾¤ä¸­ï¼Œå¹¶è¢« Kubernetes API ç®¡ç†ã€‚</li>
<li>Ingress èµ„æº æ˜¯ Kubernetes çš„ API å¯¹è±¡ï¼Œå®ƒå®šä¹‰äº†å¦‚ä½•å°†å¤–éƒ¨è¯·æ±‚è·¯ç”±åˆ°é›†ç¾¤å†…çš„æœåŠ¡ã€‚Ingress èµ„æºåŒ…å«äº†è·¯ç”±è§„åˆ™ï¼Œä¾‹å¦‚åŸºäºåŸŸåæˆ–è·¯å¾„çš„è·¯ç”±ã€‚</li>
<li>é¦–å…ˆï¼Œä½ éœ€è¦éƒ¨ç½²ä¸€ä¸ª Ingress Controllerï¼ˆæ¯”å¦‚ NGINX Ingress Controllerï¼‰åˆ°ä½ çš„ Kubernetes é›†ç¾¤ä¸­ã€‚è¿™ä¸ª Controller ä¼šä½œä¸ºä¸€ä¸ªæœåŠ¡è¿è¡Œï¼Œå¹¶ä¸”ç›‘å¬ API Server ä»¥è·å– Ingress èµ„æºçš„å˜åŒ–ã€‚</li>
<li>ç„¶åï¼Œä½ åˆ›å»º Ingress èµ„æºï¼Œå®šä¹‰äº†è·¯ç”±è§„åˆ™ã€‚è¿™äº›è§„åˆ™å‘Šè¯‰ Ingress Controller å¦‚ä½•å°†è¿›å…¥çš„è¯·æ±‚è½¬å‘åˆ°é›†ç¾¤å†…çš„ç‰¹å®šæœåŠ¡ã€‚</li>
<li>å½“å¤–éƒ¨è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œå®ƒä»¬é¦–å…ˆä¼šè¢« Ingress Controller æ¥æ”¶ï¼Œç„¶åæ ¹æ® Ingress èµ„æºä¸­å®šä¹‰çš„è§„åˆ™ï¼Œå°†è¯·æ±‚è·¯ç”±åˆ°æ­£ç¡®çš„æœåŠ¡ã€‚</li>
<li>Ingress Controller æ˜¯å®ç° Ingress è§„åˆ™çš„ç»„ä»¶ï¼Œè€Œ Ingress èµ„æºå®šä¹‰äº†è¿™äº›è§„åˆ™</li>
</ul>
<h2 id="é—®é¢˜è®°å½•"><a href="#é—®é¢˜è®°å½•" class="headerlink" title="é—®é¢˜è®°å½•"></a>é—®é¢˜è®°å½•</h2><p><strong>å¦‚ä½•æŸ¥çœ‹</strong> <strong>Ingress</strong> <strong>é…ç½®æ˜¯å¦åŠ è½½åˆ° Nginx ä¸­</strong></p>
<p>Pod å®ä¾‹åç§°ï¼šingress-web-ingress-nginx-controller-5cxxxxxf4b-jxxxr</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ingress-web-ingress-nginx-controller-5cxxxxxf4b-jxxxr:/etc/nginx$ pwd</span><br><span class="line">/etc/nginx</span><br><span class="line">ingress-web-ingress-nginx-controller-5cxxxxxf4b-jxxxr:/etc/nginx$ cat nginx.conf</span><br></pre></td></tr></table></figure>

<p><strong>æµ‹è¯• <code>ingress-nginx-controller</code> è®¿é—®é‰´æƒæœåŠ¡çš„æ¥å£</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ingress-web-ingress-nginx-controller-5cxxxxxf4b-jxxxr:/etc/nginx$ curl -H &quot;Authorization:bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI1IiwidHlwZSI6IkFDQ0VTU19UT0tFTiIsInJvbGUiOiJVU0VSIiwiZXhwIjoxNzM0NTc1MDQzLCJpYXQiOjE3MjkzOTEwNDN9.4WvI5ldUidYxtYonCNZZ2rurW6U2B8A5xSpLhs-_WUU&quot; -i http://auth-service.default:7777/api/auth</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Access-Control-Allow-Headers: Content-Type, Origin, X-CSRF-Token, Authorization, AccessToken, Token, Range</span><br><span class="line">Access-Control-Allow-Methods: GET, HEAD, POST, PATCH, PUT, DELETE</span><br><span class="line">Access-Control-Allow-Origin: *</span><br><span class="line">Access-Control-Expose-Headers: Content-Length, Access-Control-Allow-Origin, Access-Control-Allow-Headers</span><br><span class="line">Access-Control-Max-Age: 86400</span><br><span class="line">Traceparent: 00-eea4932e4369c57578feb3c51a3bb081-cda499a1e131d834-00</span><br><span class="line">Vary: Origin</span><br><span class="line">X-User-Id: 5</span><br><span class="line">X-User-Role: USER</span><br><span class="line">X-User-Uuid: c2a2b349b565403fa98b72691ec40d12</span><br><span class="line">Date: Tue, 03 Dec 2024 08:38:27 GMT</span><br><span class="line">Content-Length: 0</span><br><span class="line"></span><br><span class="line">ingress-web-ingress-nginx-controller-5cxxxxxf4b-jxxxr:/etc/nginx$ </span><br></pre></td></tr></table></figure>

<p><strong>æŒç»­æŸ¥çœ‹ Nginx æ—¥å¿—</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ingress-web-ingress-nginx-controller-54xxxxxx58-bh4bl:/etc/nginx$ tail -f /var/log/nginx/nginx_access.log</span><br></pre></td></tr></table></figure>

<p><strong><a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/457/48949#.E9.80.9A.E8.BF.87-service-.E8.B5.84.E6.BA.90.E7.9A.84.E9.85.8D.E7.BD.AE.E9.80.89.E9.A1.B9.E4.BF.9D.E7.95.99.E5.AE.A2.E6.88.B7.E7.AB.AF.E6.BA.90-ip">åœ¨ TKE ä¸­è·å–å®¢æˆ·ç«¯çœŸå®æº IP</a></strong></p>


<!-- 
<div class="article-footer reveal fs14"><section id="license"><div class="header"><span>è®¸å¯åè®®</span></div><div class="body"><p>æœ¬æ–‡é‡‡ç”¨ <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…</a> è®¸å¯åè®®ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
</div></section></div> -->

</article>

<div class="related-wrap reveal" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">è¾ƒæ–°æ–‡ç« </div><a href="/2024/09/23/docker/">å®¹å™¨æŠ€æœ¯å®è·µä¸æ¢ç´¢ - Docker ğŸ³</a></div><div class="item" id="next"><div class="note">è¾ƒæ—©æ–‡ç« </div><a href="/2024/07/04/redis-lock/">åŸºäº Redis å®ç°åˆ†å¸ƒå¼é” ğŸ”’ - Golang</a></div></section></div>






  <div class='related-wrap md-text reveal' id="comments">
    <section class='header cmt-title cap theme'>
      å¿«æ¥å‚ä¸è®¨è®ºå§
    </section>
    <section class='body cmt-body giscus'>
      

<svg class="loading" style="vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg>

<div id="giscus" data-repo="hcjjj/blog-comments" data-repo-id="R_kgDOM8H5Mg" data-category="Announcements" data-category-id="DIC_kwDOM8H5Ms4CjGw7" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous"></div>

    </section>
  </div>



      <!-- 
<footer class="page-footer reveal fs12"><hr><div class="text"><p>æœ¬ç«™ç”± <a href="/">@anonymity</a> ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://github.com/xaoxuu/hexo-theme-stellar">Stellar</a> ä¸»é¢˜åˆ›å»ºã€‚<br>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>
</div></footer> -->

      <div class='float-panel mobile-only blur' style='display:none'>
  <button type='button' class='sidebar-toggle mobile' onclick='sidebar.toggle()'>
    <svg class="icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15301"><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 2.3 26.8 24.6 47.5 51.6 47.6h416.5v4z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15302"></path><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 1.9 27.7 23.9 49.7 51.6 51.6h416.5z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15303"></path></svg>
  </button>
</div>

    </div>
  </div>
  <div class='scripts'>
    <script type="text/javascript">
  const stellar = {
    // æ‡’åŠ è½½ css https://github.com/filamentgroup/loadCSS
    loadCSS: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    // ä» butterfly å’Œ volantis è·å¾—çµæ„Ÿ
    loadScript: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      if (src.startsWith('/')){
        src = stellar.config.root + src.substring(1);
      }
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // é»˜è®¤å¼‚æ­¥ï¼Œå¦‚æœéœ€è¦åŒæ­¥ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥ {} å³å¯
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    // https://github.com/jerryc127/hexo-theme-butterfly
    jQuery: (fn) => {
      if (typeof jQuery === 'undefined') {
        stellar.loadScript(stellar.plugins.jQuery).then(fn)
      } else {
        fn()
      }
    }
  };
  stellar.version = '1.19.0';
  stellar.github = 'https://github.com/xaoxuu/hexo-theme-stellar/tree/1.19.0';
  stellar.config = {
    date_suffix: {
      just: 'åˆšåˆš',
      min: 'åˆ†é’Ÿå‰',
      hour: 'å°æ—¶å‰',
      day: 'å¤©å‰',
      month: 'ä¸ªæœˆå‰',
    },
    root : '/',
  };

  // required plugins (only load if needs)
  stellar.plugins = {
    jQuery: 'https://gcore.jsdelivr.net/npm/jquery@3.6.2/dist/jquery.min.js'
  };

  if ('local_search') {
    stellar.search = {};
    stellar.search.service = 'local_search';
    if (stellar.search.service == 'local_search') {
      let service_obj = Object.assign({}, {"field":"all","path":"/search.json","content":true,"sort":"-date"});
      stellar.search[stellar.search.service] = service_obj;
    }
  }

  // stellar js
  stellar.plugins.stellar = Object.assign({"sites":"/js/plugins/sites.js","friends":"/js/plugins/friends.js","ghinfo":"/js/plugins/ghinfo.js","timeline":"/js/plugins/timeline.js","linkcard":"/js/plugins/linkcard.js","fcircle":"/js/plugins/fcircle.js","weibo":"/js/plugins/weibo.js"});

  stellar.plugins.marked = Object.assign("https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js");
  // optional plugins
  if ('true' == 'true') {
    stellar.plugins.lazyload = Object.assign({"enable":true,"js":"https://gcore.jsdelivr.net/npm/vanilla-lazyload@17.8.3/dist/lazyload.min.js","transition":"blur"});
  }
  if ('true' == 'true') {
    stellar.plugins.swiper = Object.assign({"enable":true,"css":"https://unpkg.com/swiper@8.4.5/swiper-bundle.min.css","js":"https://unpkg.com/swiper@8.4.5/swiper-bundle.min.js"});
  }
  if ('' == 'true') {
    stellar.plugins.scrollreveal = Object.assign({"enable":null,"js":"https://gcore.jsdelivr.net/npm/scrollreveal@4.0.9/dist/scrollreveal.min.js","distance":"8px","duration":500,"interval":100,"scale":1});
  }
  if ('true' == 'true') {
    stellar.plugins.preload = Object.assign({"enable":true,"service":"flying_pages","instant_page":"https://gcore.jsdelivr.net/gh/volantis-x/cdn-volantis@4.1.2/js/instant_page.js","flying_pages":"https://gcore.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"});
  }
  if ('true' == 'true') {
    stellar.plugins.fancybox = Object.assign({"enable":true,"js":"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js","css":"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css","selector":".swiper-slide img"});
  }
  if ('false' == 'true') {
    stellar.plugins.heti = Object.assign({"enable":false,"css":"https://unpkg.com/heti@0.9.2/umd/heti.min.css","js":"https://unpkg.com/heti@0.9.2/umd/heti-addon.min.js"});
  }
  if ('true' == 'true') {
    stellar.plugins.copycode = Object.assign({"enable":true,"js":"/js/plugins/copycode.js","default_text":"Copy","success_text":"Copied"});
  }
</script>

<!-- required -->

  
<script src="/js/main.js" async></script>



<!-- optional -->

  <script>
  function loadJS() {
    const els = document.querySelectorAll("#comments #giscus");
    if (els.length === 0) return;
    els.forEach((el, i) => {
      try {
        el.innerHTML = '';
      } catch (error) {
        console.log(error);
      }
      var script = document.createElement('script');
      script.src = 'https://giscus.app/client.js';
      script.async = true;
      for (let key of Object.keys(el.attributes)) {
        let attr = el.attributes[key];
        if (['class', 'id'].includes(attr.name) === false) {
          script.setAttribute(attr.name, attr.value);
        }
      }
      el.appendChild(script);
    });
  }
  window.addEventListener('DOMContentLoaded', (event) => {
    loadJS();
  });
</script>




<!-- inject -->


  </div>
</body>
</html>
